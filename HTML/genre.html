<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Thể loại - Game Downloader</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
  <style>
    body { background:#f7f7f8; color:#222; }
    .container { max-width:1200px; }
    #genreTitle { font-size:28px; color:#ff7f50; font-weight:700; margin:18px 0; text-align:center; text-transform:capitalize; }
    #gamesContainer .card { border-radius:14px; overflow:hidden; border:none; box-shadow:0 6px 18px rgba(0,0,0,0.08); transition:0.25s; }
    #gamesContainer .card:hover { transform:translateY(-6px); box-shadow:0 12px 26px rgba(0,0,0,0.12); }
    .card-img-top { height:160px; object-fit:cover; background:#ddd; }
    .card-title { font-size:16px; font-weight:700; }
    .card-sub { font-size:13px; color:#666; margin-top:6px; display:block; }
    .no-results { text-align:center; padding:40px 0; color:#666; }
    /* pagination custom */
    .pagination { gap:6px; display:flex; flex-wrap:wrap; justify-content:center; padding-left:0; list-style:none; }
    .pagination .page-link { border-radius:10px; color:#ff7f50; border:1px solid #ffd6c4; padding:8px 12px; }
    .pagination .page-item.active .page-link { background:#ff7f50; color:#fff; border-color:#ff7f50; }
    .pagination .page-link:hover { background:#ff7f50; color:#fff; }
    /* responsive */
    @media (max-width:576px) {
      .card-img-top { height:120px; }
    }
  </style>
</head>
<body>
  <div class="container py-4">
    <h2 id="genreTitle">Thể loại: Tất cả</h2>

    <div id="gamesContainer" class="row g-3 mt-3"></div>

    <nav aria-label="Trang">
      <ul id="pagination" class="pagination mt-4"></ul>
    </nav>

    <div id="debug" style="display:none; margin-top:12px; color:#999; font-size:13px"></div>
  </div>

  <script>
    (function(){
      const API_KEY = "d63e85e85042401899d08350ad872094"; // Tao đã thay key của mày
      const PAGE_SIZE = 12;

      const params = new URLSearchParams(window.location.search);
      const genre = params.get("type") || ""; // page được truyền là ?type=slug
      let page = parseInt(params.get("page")||"1", 10);
      if (isNaN(page) || page < 1) page = 1;

      const titleEl = document.getElementById("genreTitle");
      const container = document.getElementById("gamesContainer");
      const paginationEl = document.getElementById("pagination");
      const debugEl = document.getElementById("debug");

      titleEl.textContent = "Thể loại: " + (genre || "Tất cả");

      async function fetchGames(pageNum = 1) {
        const base = "https://api.rawg.io/api/games";
        const u = new URL(base);
        u.searchParams.set("key", API_KEY);
        u.searchParams.set("page", pageNum);
        u.searchParams.set("page_size", PAGE_SIZE);
        if (genre) u.searchParams.set("genres", genre);
        // thêm ordering nếu muốn: u.searchParams.set('ordering','-released');
        debugLog("Gọi API: " + u.toString());

        try {
          const res = await fetch(u.toString());
          if (!res.ok) throw new Error("HTTP " + res.status);
          const data = await res.json();
          return data;
        } catch (err) {
          console.error("Lỗi fetch RAWG:", err);
          debugLog("Lỗi fetch: " + err.message);
          return null;
        }
      }

      function renderGames(items) {
        container.innerHTML = "";
        if (!items || items.length === 0) {
          container.innerHTML = `<div class="col-12"><div class="no-results">Không tìm thấy game nào cho thể loại này.</div></div>`;
          return;
        }

        items.forEach(game => {
          const img = game.background_image || "https://png.pngtree.com/png-clipart/20190920/original/pngtree-blue-gamepad-illustration-png-image_4635515.jpg";
          const released = game.released || "—";
          const rating = (game.rating != null) ? game.rating : "—";
          const col = document.createElement("div");
          col.className = "col-6 col-md-3";
          col.innerHTML = `
            <div class="card h-100" data-id="${game.id}">
              <img src="${img}" alt="${escapeHtml(game.name)}" class="card-img-top" onerror="this.onerror=null;this.src='https://png.pngtree.com/png-clipart/20190920/original/pngtree-blue-gamepad-illustration-png-image_4635515.jpg'">
              <div class="card-body d-flex flex-column">
                <div>
                  <h5 class="card-title">${escapeHtml(game.name)}</h5>
                  <span class="card-sub">Rating: ${rating} · Phát hành: ${escapeHtml(released)}</span>
                </div>
                <div class="mt-auto">
                  <a href="info.html?id=${game.id}" class="btn btn-sm btn-primary w-100 mt-3">Xem chi tiết</a>
                </div>
              </div>
            </div>
          `;
          container.appendChild(col);
        });
      }

      function buildPagination(totalItems, currentPage) {
        paginationEl.innerHTML = "";
        const totalPages = Math.max(1, Math.ceil((totalItems||0) / PAGE_SIZE));
        if (totalPages <= 1) return;

        // helper to create li
        function liPage(pageNum, label, active=false, disabled=false) {
          const li = document.createElement("li");
          li.className = "page-item" + (active ? " active" : "") + (disabled ? " disabled" : "");
          const a = document.createElement("a");
          a.className = "page-link";
          a.href = buildUrl(pageNum);
          a.textContent = label ?? pageNum;
          li.appendChild(a);
          return li;
        }

        // first / prev
        paginationEl.appendChild(liPage(1, "« Đầu", false, currentPage <= 1));
        paginationEl.appendChild(liPage(Math.max(1, currentPage-1), "‹ Trước", false, currentPage <= 1));

        // windowed page numbers
        const WINDOW = 5;
        let start = Math.max(1, currentPage - Math.floor(WINDOW/2));
        let end = Math.min(totalPages, start + WINDOW - 1);
        if (end - start + 1 < WINDOW) start = Math.max(1, end - WINDOW + 1);

        if (start > 1) {
          paginationEl.appendChild(liPage(1, "1"));
          if (start > 2) {
            const dots = document.createElement("li");
            dots.className = "page-item disabled";
            dots.innerHTML = `<span class="page-link">…</span>`;
            paginationEl.appendChild(dots);
          }
        }

        for (let i = start; i <= end; i++) {
          paginationEl.appendChild(liPage(i, i.toString(), i === currentPage));
        }

        if (end < totalPages) {
          if (end < totalPages - 1) {
            const dots = document.createElement("li");
            dots.className = "page-item disabled";
            dots.innerHTML = `<span class="page-link">…</span>`;
            paginationEl.appendChild(dots);
          }
          paginationEl.appendChild(liPage(totalPages, totalPages.toString()));
        }

        // next / last
        paginationEl.appendChild(liPage(Math.min(totalPages, currentPage+1), "Tiếp ›", false, currentPage >= totalPages));
        paginationEl.appendChild(liPage(totalPages, "Cuối »", false, currentPage >= totalPages));
      }

      function buildUrl(pageNum) {
        const u = new URL(window.location.href);
        u.searchParams.set("page", pageNum);
        if (genre) u.searchParams.set("type", genre);
        else u.searchParams.delete("type");
        return u.pathname + "?" + u.searchParams.toString();
      }

      function escapeHtml(s="") {
        return String(s).replace(/[&<>"']/g, function(ch){
          return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[ch]);
        });
      }

      function debugLog(msg) {
        debugEl.style.display = "block";
        debugEl.textContent = msg;
      }

      // main
      (async function main(){
        debugLog("Đang tải dữ liệu...");
        const data = await fetchGames(page);
        if (!data) {
          container.innerHTML = `<div class="col-12"><div class="no-results">Không thể tải dữ liệu. Kiểm tra console (F12).</div></div>`;
          return;
        }
        // data.count, data.results
        renderGames(data.results || []);
        buildPagination(data.count || (data.results? data.results.length: 0), page);
        debugEl.textContent = `Tổng: ${data.count ?? (data.results? data.results.length: 0)} game — Trang ${page}`;
      })();
    })();
  </script>
</body>
</html>
