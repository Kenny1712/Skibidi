<!DOCTYPE html>
<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>T√¨m ki·∫øm game</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css"
      rel="stylesheet"
      crossorigin="anonymous"
    />
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"
      crossorigin="anonymous"
    ></script>
    <link rel="stylesheet" href="../Css/search.css" />
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>

    
  </head>

  <body>
    <!-- NAVBAR (gi·ªØ nguy√™n, ƒë√£ OK) -->
    <nav class="navbar navbar-expand-lg custom-navbar mb-3">
      <div class="container-fluid">
        <a
          class="navbar-brand d-flex align-items-center"
          href="../HTML/index.html"
        >
          <img
            src="../Img/Game_logo.webp"
            alt="Logo"
            style="height: 40px; margin-right: 8px"
          />
          <span>Game downloader</span>
        </a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#mainNavbar"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div
          class="collapse navbar-collapse justify-content-end"
          id="mainNavbar"
        >
          <ul class="navbar-nav mb-2 mb-lg-0">
            <li class="nav-item">
              <a class="btn btn-search-nav ms-2" href="./search.html"
                >üîç T√¨m ki·∫øm game</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link" href="./new_game.html">Game m·ªõi</a>
            </li>
            
            <li class="nav-item">
              <a class="nav-link" href="./login.html" id="loginBtn"
                >ƒêƒÉng nh·∫≠p</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link" href="./register.html" id="registerBtn"
                >ƒêƒÉng k√Ω</a
              >
            </li>
            <select id="genreSelect" class="form-select genre-dropdown">
    <option value="">T·∫•t c·∫£ th·ªÉ lo·∫°i</option>
    <option value="action">H√†nh ƒë·ªông</option>
    <option value="adventure">Phi√™u l∆∞u</option>
    <option value="role-playing-games-rpg">Nh·∫≠p vai</option>
    <option value="horror">Kinh d·ªã</option>
    <option value="sports">Th·ªÉ thao</option>
    <option value="simulation">M√¥ ph·ªèng</option>
</select>

            <li
              class="nav-item dropdown user-dropdown"
              id="userDropdown"
              style="display: none"
            >
              <a
                class="nav-link dropdown-toggle d-flex align-items-center"
                href="#"
                id="userDropdownBtn"
                role="button"
                data-bs-toggle="dropdown"
              >
                <img
                  id="userAvatar"
                  src="../Img/user.jpg"
                  alt="User"
                  class="user-avatar"
                  style="height: 32px; border-radius: 50%"
                />
                <span id="userNameLabel" style="margin-left: 8px"></span>
              </a>
              <ul
                class="dropdown-menu user-menu dropdown-menu-end"
                aria-labelledby="userDropdownBtn"
              >
                <li>
                  <span class="dropdown-item-text" id="userEmail"
                    >dochibinh1981@gmail.com</span
                  >
                </li>
                <li>
                  <span class="dropdown-item-text"
                    >S·ªë d∆∞:
                    <span id="dropdownBalance" style="color: red"
                      >0 ƒë</span
                    ></span
                  >
                </li>
                <li><hr class="dropdown-divider" /></li>
                <li>
                  <a class="dropdown-item" href="./profile.html">T√†i kho·∫£n</a>
                </li>
                <li>
                  <a class="dropdown-item" href="./deposit_money.html"
                    >N·∫°p ti·ªÅn</a
                  >
                </li>
                <li>
                  <a class="dropdown-item" href="./leaderboard.html"
                    >Top n·∫°p ti·ªÅn</a
                  >
                </li>
                <li>
                  <a class="dropdown-item" href="./purchased.html"
                    >Game ƒë√£ mua</a
                  >
                </li>
                <li><hr class="dropdown-divider" /></li>
                <li>
                  <a class="dropdown-item" href="#" id="logoutBtnDropdown"
                    >ƒêƒÉng xu·∫•t</a
                  >
                </li>
              </ul>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <h1>T√¨m ki·∫øm game</h1>

    <!-- Search + Filter -->
    <div class="search-container">
      <input
        id="search"
        type="search"
        placeholder="T√¨m game (v√≠ d·ª•: zelda, mario)"
        class="form-control"
        style="max-width: 420px"
      />
      <button id="btnSearch" class="btn btn-primary">T√¨m</button>

      <select id="genreSelect" class="form-select" style="max-width: 220px">
        <option value="">T·∫•t c·∫£ th·ªÉ lo·∫°i</option>
        <option value="action">H√†nh ƒë·ªông</option>
        <option value="adventure">Phi√™u l∆∞u</option>
        <option value="role-playing-games-rpg">Nh·∫≠p vai</option>
        <option value="horror">Kinh d·ªã</option>
        <option value="sports">Th·ªÉ thao</option>
        <option value="simulation">M√¥ ph·ªèng</option>
      </select>
    </div>
    <div class="skibidi">
      S·ªë k·∫øt qu·∫£ t√¨m ƒë∆∞·ª£c: <span id="count">0</span>
    </div>
    <main>
      <div id="results" class="game-list"></div>

      <div class="pagination">
        <button class="footer-button" id="firstPageBtn">¬´ ƒê·∫ßu</button>
        <button class="footer-button" id="prevPageBtn">¬´ Tr∆∞·ªõc</button>
        <span id="pageInfo">Trang 1</span>
        <button class="footer-button" id="nextPageBtn">Ti·∫øp ¬ª</button>
        <button class="footer-button" id="lastPageBtn">Cu·ªëi ¬ª</button>

        <input
          type="number"
          id="pageInput"
          min="1"
          placeholder="Nh·∫≠p trang..."
        />
        <button class="footer-button" id="goBtn">ƒêi</button>
      </div>
    </main>

    <!-- SCRIPT: logic (s·ª≠a l·ªói ID & k·∫øt h·ª£p genre + search + pagination) -->
    <script>
      const API_KEY = "d63e85e85042401899d08350ad872094";
      const PAGE_SIZE = 24;
      let currentPage = 1;
      let totalPages = 1;
      let lastQuery = "";
      let selectedGenre = "";

      const resultsEl = document.getElementById("results");
      const countEl = document.getElementById("count");
      const searchInput = document.getElementById("search");
      const btnSearch = document.getElementById("btnSearch");
      const firstBtn = document.getElementById("firstPageBtn");
      const prevBtn = document.getElementById("prevPageBtn");
      const nextBtn = document.getElementById("nextPageBtn");
      const lastBtn = document.getElementById("lastPageBtn");
      const pageInfo = document.getElementById("pageInfo");
      const pageInput = document.getElementById("pageInput");
      const goBtn = document.getElementById("goBtn");
      const genreSelect = document.getElementById("genreSelect");

      async function fetchGames({ page = 1, search = "", genre = "" } = {}) {
        const url = new URL("https://api.rawg.io/api/games");
        url.searchParams.set("key", API_KEY);
        url.searchParams.set("page", page);
        url.searchParams.set("page_size", PAGE_SIZE);
        if (search) url.searchParams.set("search", search);
        if (genre) url.searchParams.set("genres", genre);

        try {
          const res = await fetch(url.toString());
          if (!res.ok) throw new Error("HTTP " + res.status);
          const data = await res.json();
          return data;
        } catch (err) {
          console.error("L·ªói fetch RAWG:", err);
          return null;
        }
      }

      function escapeHtml(str = "") {
        return String(str).replace(
          /[&<>"']/g,
          (s) =>
            ({
              "&": "&amp;",
              "<": "&lt;",
              ">": "&gt;",
              '"': "&quot;",
              "'": "&#39;",
            }[s])
        );
      }

      function renderGames(data) {
        resultsEl.innerHTML = "";
        if (!data || !data.results) {
          resultsEl.innerHTML = "<p>Kh√¥ng l·∫•y ƒë∆∞·ª£c d·ªØ li·ªáu.</p>";
          countEl.textContent = "0";
          return;
        }
        countEl.textContent = data.count ?? data.results.length;
        data.results.forEach((g) => {
          const card = document.createElement("article");
          card.className = "game-card";
          card.innerHTML = `
          <img src="${g.background_image ?? ""}" alt="${escapeHtml(g.name)}"
            onerror="this.onerror=null;this.src='https://png.pngtree.com/png-clipart/20190920/original/pngtree-blue-gamepad-illustration-png-image_4635515.jpg'"/>
          <h2 style="margin:8px 0 4px">${escapeHtml(g.name)}</h2>
          <!-- <div class="meta">Rating: ${g.rating} ¬∑ Released: ${
            g.released ?? "‚Äî"
          }</div> -->
        `;
          card.addEventListener(
            "click",
            () => (window.location.href = `info.html?id=${g.id}`)
          );
          resultsEl.appendChild(card);
        });
      }

      async function loadPage(page = 1, search = "") {
        if (page < 1) page = 1;
        const data = await fetchGames({ page, search, genre: selectedGenre });
        if (!data) return;
        totalPages = Math.max(
          1,
          Math.ceil((data.count || data.results.length) / PAGE_SIZE)
        );
        currentPage = page;
        renderGames(data);
        pageInfo.textContent = `Trang ${currentPage} / ${totalPages}`;
        firstBtn.disabled = prevBtn.disabled = currentPage <= 1;
        lastBtn.disabled = nextBtn.disabled = currentPage >= totalPages;
        pageInput.value = "";
      }

      // events
      firstBtn.addEventListener("click", () => loadPage(1, lastQuery));
      prevBtn.addEventListener("click", () =>
        loadPage(currentPage - 1, lastQuery)
      );
      nextBtn.addEventListener("click", () =>
        loadPage(currentPage + 1, lastQuery)
      );
      lastBtn.addEventListener("click", () => loadPage(totalPages, lastQuery));
      goBtn.addEventListener("click", () => {
        const p = parseInt(pageInput.value);
        if (!isNaN(p) && p >= 1 && p <= totalPages) loadPage(p, lastQuery);
        else alert("S·ªë trang kh√¥ng h·ª£p l·ªá!");
      });
      pageInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") goBtn.click();
      });

      btnSearch.addEventListener("click", () => {
        lastQuery = searchInput.value.trim();
        loadPage(1, lastQuery);
      });
      searchInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") btnSearch.click();
      });

      genreSelect.addEventListener("change", () => {
        selectedGenre = genreSelect.value;
        loadPage(1, lastQuery);
      });

      // init
      loadPage(1);

      // small niceties
      document
        .getElementById("logoutBtnDropdown")
        ?.addEventListener("click", () => {
          localStorage.removeItem("loggedIn");
          localStorage.removeItem("currentUser");
          localStorage.removeItem("currentEmail");
          location.reload();
        });
      // restore avatar & balance
      window.addEventListener("load", () => {
        const savedAvatar = localStorage.getItem("userAvatar");
        if (savedAvatar)
          document.getElementById("userAvatar").src = savedAvatar;
        const balance = localStorage.getItem("userBalance");
        if (balance != null)
          document.getElementById("dropdownBalance").textContent =
            Number(balance).toLocaleString() + " ƒë";
        const isLoggedIn = localStorage.getItem("loggedIn");
        if (isLoggedIn === "true") {
          document.getElementById("loginBtn").style.display = "none";
          document.getElementById("registerBtn").style.display = "none";
          document.getElementById("userDropdown").style.display = "block";
          document.getElementById("userNameLabel").textContent =
            localStorage.getItem("currentUser") || "";
          document.getElementById("userEmail").textContent =
            localStorage.getItem("currentEmail") || "dochibinh1981@gmail.com";
        }
      });



      document.getElementById("genreSelect")?.addEventListener("change", function () {
    const genre = this.value;
    window.location.href = genre 
        ? `genre.html?type=${genre}`
        : `genre.html`;
});

    </script>

    <button
      id="scrollToTop"
      title="L√™n ƒë·∫ßu trang"
      style="position: fixed; right: 12px; bottom: 12px; padding: 8px 10px"
    >
      ‚¨Ü
    </button>

    <button id="scrollToTop" title="L√™n ƒë·∫ßu trang">‚¨Ü</button>
  </body>
  <footer class="fancy-footer">
    <div class="footer-container">
      <div class="footer-section brand">
        <img src="../Img/Game_logo.webp" alt="Logo" />
        <h2>Game Downloader</h2>
        <p>T·∫£i game t·ªëc ƒë·ªô cao ‚Äì C·∫≠p nh·∫≠t game hot m·ªói ng√†y!</p>
      </div>

      <div class="footer-section links">
        <h3>Danh m·ª•c</h3>
        <ul>
          <li><a href="./index.html">Trang ch·ªß</a></li>
          <li><a href="./new_game.html">Game m·ªõi</a></li>
          <li><a href="./tintuc_1.html">Tin t·ª©c</a></li>
        </ul>
      </div>

      <div class="footer-section support">
        <h3>H·ªó tr·ª£</h3>
        <ul>
          <li><a href="#">Ch√≠nh s√°ch b·∫£o m·∫≠t</a></li>
          <li><a href="#">ƒêi·ªÅu kho·∫£n s·ª≠ d·ª•ng</a></li>
          <li><a href="#">Li√™n h·ªá</a></li>
          <li><a href="#">FAQs</a></li>
        </ul>
      </div>

      <div class="footer-section social">
        <h3>K·∫øt n·ªëi</h3>
        <div class="social-icons">
          <a href="#"><img src="../Img/Facebook.webp" alt="Facebook" /></a>
          <a href="#"><img src="../Img/YouTube.png" alt="YouTube" /></a>
          <a href="#"><img src="../Img/tiktok.jpg" alt="TikTok" /></a>
        </div>
      </div>
    </div>

    <div class="footer-bottom">
      <p>&copy; 2025 Game Downloader. All rights reserved.</p>
    </div>
  </footer>
</html>
